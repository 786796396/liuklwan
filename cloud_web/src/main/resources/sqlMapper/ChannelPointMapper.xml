<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ucap.cloud_web.dao.ChannelPointDao">
<cache eviction="LRU" flushInterval="60000" size="1024" readOnly="true"/>
	<resultMap type="com.ucap.cloud_web.entity.ChannelPoint" id="resultMap"/>

	<sql id="where">
		<where>
			1=1
			<if test="statusIn !=null ">
				and status in (${statusIn})
			</if>
			<if test="statusFlag!=null">
				and status!=-1
			</if>
			<if test="status !=null">
				and status=#{status}
			</if>
			<if test="siteCode != null">
				and site_code=#{siteCode}
			</if>
			<if test="websiteInfoId != null">
				and website_info_id=#{websiteInfoId}
			</if>
			<if test="channelUrl != null">
				and channel_url=#{channelUrl}
			</if>
			<if test="jumpPageUrl != null">
				and jump_page_url=#{jumpPageUrl}
			</if>
			<if test="encodeUrl != null">
				and encode_url=#{encodeUrl}
			</if>
			<if test="term != null">
				and (channel_name like '%${term}%' OR channel_url like '%${term}%' OR jump_page_url like '%${term}%')
			</if>
			<if test="types !=null">
				and dic_channel_son_id in 
             	<foreach collection="types" item="item" open="(" separator="," close=")">
       					#{item}
				</foreach>
			</if>
			<if test="channelPointIdArray !=null">
				and id in 
             	<foreach collection="channelPointIdArray" item="channelPointId" open="(" separator="," close=")">
       					#{channelPointId}
				</foreach>
			</if>
			<if test="channelType != null">
				<if test="channelType == 0">
				and dic_channel_id='18'
				</if>
				<if test="channelType == 1">
				and dic_channel_id!='18'
				</if>
			</if>
		</where>
	</sql>

		<!-- 添加 -->
	<insert id="add" parameterType="com.ucap.cloud_web.entity.ChannelPoint" useGeneratedKeys="true" keyProperty="id">
		insert into channel_point ( 
			<if test="id != null ">id,</if>
			<if test="siteCode != null ">site_code,</if>
			<if test="websiteInfoId != null ">website_info_id,</if>
			<if test="dicChannelId != null ">dic_channel_id,</if>
			<if test="dicChannelSonId != null ">dic_channel_son_id,</if>
			<if test="channelName != null ">channel_name,</if>
			<if test="channelUrl != null ">channel_url,</if>
			<if test="jumpPageUrl != null ">jump_page_url,</if>
			<if test="encodeUrl != null ">encode_url,</if>
			<if test="status != null ">status,</if>
			<if test="linkStatus != null ">link_status,</if>
			<if test="paAdd != null ">pa_add,</if>
			<if test="creator != null ">creator,</if>
			<if test="created != null ">created,</if>
			create_time,
			modify_time
		) values (
			<if test="id != null ">#{id},</if>
			<if test="siteCode != null ">#{siteCode},</if>
			<if test="websiteInfoId != null ">#{websiteInfoId},</if>
			<if test="dicChannelId != null ">#{dicChannelId},</if>
			<if test="dicChannelSonId != null ">#{dicChannelSonId},</if>
			<if test="channelName != null ">#{channelName},</if>
			<if test="channelUrl != null ">#{channelUrl},</if>
			<if test="jumpPageUrl != null ">#{jumpPageUrl},</if>
			<if test="encodeUrl != null ">#{encodeUrl},</if>
			<if test="status != null ">#{status},</if>
			<if test="linkStatus != null ">#{linkStatus},</if>
			<if test="paAdd != null ">#{paAdd},</if>
			<if test="creator != null ">#{creator},</if>
			<if test="created != null ">#{created},</if>
			now(),
			now()
		)
	</insert>

	<!-- 查询 -->
	<select id="get" parameterType="int" resultType="com.ucap.cloud_web.entity.ChannelPoint">
		select * from channel_point where id=#{id}
	</select>

	<!-- 修改 -->
	<update id="update" parameterType="com.ucap.cloud_web.entity.ChannelPoint">
		update channel_point 
			<trim prefix="SET" suffixOverrides=",">
				<if test="id != null ">id = #{id},</if>
				<if test="siteCode != null ">site_code = #{siteCode},</if>
				<if test="websiteInfoId != null ">website_info_id = #{websiteInfoId},</if>
				<if test="dicChannelId != null ">dic_channel_id = #{dicChannelId},</if>
				<if test="dicChannelSonId != null ">dic_channel_son_id = #{dicChannelSonId},</if>
				<if test="channelName != null ">channel_name = #{channelName},</if>
				<if test="channelUrl != null ">channel_url = #{channelUrl},</if>
				<if test="jumpPageUrl != null ">jump_page_url = #{jumpPageUrl},</if>
				<if test="encodeUrl != null ">encode_url = #{encodeUrl},</if>
				<if test="modifier != null ">modifier = #{modifier},</if>
				<if test="status != null ">status = #{status},</if>
				<if test="linkStatus != null ">link_status = #{linkStatus},</if>
				<if test="lable != null ">lable = #{lable},</if>
				<if test="modified != null ">modified = #{modified},</if>
				modify_time=now()
			</trim>
			where id=#{id} 
	</update>

	<!-- 删除 -->
	<delete id="delete" parameterType="int">
		delete from channel_point where id = #{id}
	</delete>

	<!-- 分页查询 -->
	<select id="query" parameterType="HashMap" resultMap="resultMap">
		select * from channel_point
		<include refid="where"/>
		
		<if test="queryOrderList != null">
			order by
			<foreach collection="queryOrderList" item="queryOrder" separator=",">
				${queryOrder}
			</foreach>
		</if>
		<if test="start != null and pageSize != null">
			limit #{start}, #{pageSize}
		</if>
	</select>
	<!-- add by sunjq -->
	<select id="queryCountByType" parameterType="HashMap" resultType="int">
		select count(*) from channel_point where 
		site_code = #{siteCode} AND dic_channel_son_id in ${dicChannelSonIdList}
	</select>
	<!-- end add -->
	<select id="queryCount" parameterType="HashMap" resultType="int">
		select count(*) from channel_point
		<include refid="where" />
	</select>
	
	<select id="getChannelPointInfo" parameterType="HashMap" resultType="com.ucap.cloud_web.dtoResponse.ChannelPointResponse">
		 SELECT
			cp.id,
			cp.channel_name channelName,
			cp.channel_url channelUrl,
			cp.jump_page_url jumpPageUrl,
			cp.status status,
			cp.link_status linkStatus,
			dic.channel_name dicName,
			dich.channel_name dichName,
			dich.id dichId
		FROM
			channel_point cp,
			dic_channel dic,
			dic_channel dich
		WHERE
			cp.dic_channel_id = dic.id
		AND cp.dic_channel_son_id = dich.id
		<if test="siteCode != null">
			AND cp.site_code = #{siteCode}
		</if>
		AND cp.status !=- 1
		ORDER BY
			cp.status DESC
	</select>


	<select id="getlowerLevelList" parameterType="HashMap" resultType="com.ucap.cloud_web.dtoResponse.DatabaseInfoResponse">
		 SELECT COUNT(cp.id) channelPointNum,di.site_code,di.name,di.director,di.url,di.jump_url,di.isorganizational,
		 	di.address,di.principal_name,di.telephone,di.mobile,di.email,di.linkman_name,di.telephone_2,di.mobile_2,
		 	di.email_2 FROM	database_tree_info dti
			left join database_info di on di.site_code = dti.site_code
			left join channel_point cp on  di.site_code = cp.site_code and cp.status != '-1'
		<where>
			<if test="orgSiteCode != null">
				AND dti.org_site_code = #{orgSiteCode}
			</if>
			<if test="level != null">
				AND dti.layer_type = #{level}
			</if>
			<if test="isLink != null">
				AND dti.is_link = #{isLink}
			</if>	
			<if test="isExp != null">
				AND di.isexp = #{isExp}
			</if>	
			AND IFNULL(cp.status,0)!='-1'
		</where>
		GROUP BY di.site_code
	</select>

</mapper>
