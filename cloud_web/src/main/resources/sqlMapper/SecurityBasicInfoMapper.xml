<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ucap.cloud_web.dao.SecurityBasicInfoDao">

	<cache eviction="LRU" flushInterval="60000" size="1024" readOnly="true"/>

	<resultMap type="com.ucap.cloud_web.entity.SecurityBasicInfo" id="resultMap"/>

	<sql id="where">
		<where>
			1=1
			<if test="siteCode !=null">
				and site_code =#{siteCode}
			</if>
			<if test="servicePeriodId !=null and servicePeriodId !=0">
				and service_period_id =#{servicePeriodId}
			</if>
			<if test="channelName !=null">
				and channel_name like '%${channelName}%'
			</if>
			<if test="scanDate !=null">
				<![CDATA[ and scan_date<=#{scanDate} ]]>
			</if>
			
		</where>
	</sql>

	<!-- 添加 -->
	<insert id="add" parameterType="com.ucap.cloud_web.entity.SecurityBasicInfo" useGeneratedKeys="true" keyProperty="id">
		insert into security_basic_info ( 
			<if test="id != null ">id,</if>
			<if test="siteCode != null ">site_code,</if>
			<if test="channelUrl != null ">channel_url,</if>
			<if test="channelName != null ">channel_name,</if>
			<if test="problemTypId != null ">problem_typ_id,</if>
			<if test="imgUrl != null ">img_url,</if>
			<if test="scanDate != null ">scan_date,</if>
			<if test="userId != null ">user_id,</if>
			create_time,
			modify_time,
			<if test="problemDesc != null ">problem_desc,</if>
			<if test="servicePeriodId != null ">service_period_id,</if>
		) values (
			<if test="id != null ">#{id},</if>
			<if test="siteCode != null ">#{siteCode},</if>
			<if test="channelUrl != null ">#{channelUrl},</if>
			<if test="channelName != null ">#{channelName},</if>
			<if test="problemTypId != null ">#{problemTypId},</if>
			<if test="imgUrl != null ">#{imgUrl},</if>
			<if test="scanDate != null ">#{scanDate},</if>
			<if test="userId != null ">#{userId},</if>
			now(),
			now(),
			<if test="problemDesc != null ">#{problemDesc},</if>
			<if test="servicePeriodId != null ">#{servicePeriodId},</if>
		)
	</insert>

	<!-- 查询 -->
	<select id="get" parameterType="int" resultType="com.ucap.cloud_web.entity.SecurityBasicInfo">
		select * from security_basic_info where id=#{id}
	</select>

	<!-- 修改 -->
	<update id="update" parameterType="com.ucap.cloud_web.entity.SecurityBasicInfo">
		update security_basic_info 
			<trim prefix="SET" suffixOverrides=",">
				<if test="id != null ">id = #{id},</if>
				<if test="siteCode != null ">site_code = #{siteCode},</if>
				<if test="channelUrl != null ">channel_url = #{channelUrl},</if>
				<if test="channelName != null ">channel_name = #{channelName},</if>
				<if test="problemTypId != null ">problem_typ_id = #{problemTypId},</if>
				<if test="imgUrl != null ">img_url = #{imgUrl},</if>
				<if test="scanDate != null ">scan_date = #{scanDate},</if>
				<if test="userId != null ">user_id = #{userId},</if>
				<if test="createTime != null ">create_time = #{createTime},</if>
				<if test="modifyTime != null ">modify_time = #{modifyTime},</if>
				<if test="problemDesc != null ">problem_desc = #{problemDesc},</if>
				<if test="servicePeriodId != null ">service_period_id = #{servicePeriodId},</if>
			</trim>
			where id=#{id} 
	</update>

	<!-- 删除 -->
	<delete id="delete" parameterType="int">
		delete from security_basic_info where id = #{id}
	</delete>

	<!-- 分页查询 -->
	<select id="query" parameterType="HashMap" resultMap="resultMap">
		select * from security_basic_info
		<include refid="where"/>
		<if test="queryOrderList != null">
			order by
			<foreach collection="queryOrderList" item="queryOrder" separator=",">
				${queryOrder}
			</foreach>
		</if>
		<if test="start != null and pageSize != null">
			limit #{start}, #{pageSize}
		</if>
	</select>
	<select id="queryCount" parameterType="HashMap" resultType="int">
		select count(*) from security_basic_info
		<include refid="where" />
	</select>
	

	<select id="getProblemNum" parameterType="HashMap" resultType="com.ucap.cloud_web.dto.SecurityBasicInfoRequest">
		SELECT 
		  COUNT(*) AS problemNum,
		  ss.site_code AS siteCode,
		  wb.name AS siteName,
		  wb.url AS homePageUrl,
		  wb.jump_url AS jumpPageUrl,
		  wb.isorganizational AS isorganizational,
		  wb.director AS director,
		  wb.address AS address,
		  wb.principal_name AS principalName,
		  wb.telephone AS telephone,
		  wb.mobile AS mobile,
		  wb.email AS email,
		  wb.linkman_name AS linkmanName,
		  wb.telephone_2 AS telephone2,
		  wb.mobile_2 AS mobile2,
		  wb.email_2 AS email2 
		FROM
		  security_basic_info ss,
		  service_period sp,
		  database_info wb 
		WHERE ss.service_period_id = sp.id 
		  AND ss.site_code =wb.site_code
		<if test="servicePeriodId!=null">
			and ss.service_period_id=#{servicePeriodId}
		</if>
		<if test="scanDate !=null">
			and ss.scan_date like '${scanDate}%'
		</if>
		<if test="ids != null">
		 	and ss.site_code in
	        <foreach collection="ids" item="term" open="(" separator="," close=")">
	     		#{term.siteCode}
			</foreach>
		</if>
		GROUP BY ss.site_code
		order by  problemNum DESC
		
	</select>
	
	<!--同一监测周期  基本信息不更新>=N个  -->
	<select id="queryBasicNum" parameterType="HashMap" resultType="com.ucap.cloud_web.dto.SecurityBasicInfoRequest">
		SELECT 
		  COUNT(*) AS basicNum,
		  sbi.site_code AS siteCode 
		FROM
		  security_basic_info sbi,
		  service_period sp 
		WHERE sbi.service_period_id = sp.id 
		<if test="siteCode !=null">
			AND sbi.site_code = #{siteCode}
		</if>
		<if test="linkList !=null">
			and sbi.site_code in
			<foreach collection="linkList" item="item" open="(" separator="," close=")">
				#{item.siteCode}
			</foreach>
		</if>
		<if test="scanDate !=null ">
			AND #{scanDate} BETWEEN sp.start_date  AND sp.end_date
		</if>
		group by sbi.site_code
		<if test="basicNum !=null">
			HAVING basicNum > #{basicNum}
		</if>
	</select>
</mapper>
