<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ucap.cloud_web.dao.SecurityBlankDetailDao">
<cache eviction="LRU" flushInterval="60000" size="1024" readOnly="true"/>
	<resultMap type="com.ucap.cloud_web.entity.SecurityBlankDetail" id="resultMap"/>

	<sql id="where">
		<where>
			1=1
			<if test="siteCode != null ">
				and site_code like '${siteCode}%'
			</if>
			<if test="channelName != null ">
				and channel_name like '%${channelName}%'
			</if>
			<if test="securityBlankInfo != 0 and securityBlankInfo !=null">
				and security_blank_info = #{securityBlankInfo}
			</if>
			<if test="servicePeriodId != 0 and servicePeriodId !=null">
				and service_period_id = #{servicePeriodId}
			</if>
			<if test="beginScanDate !=null and endScanDate !=null">
                and scan_date BETWEEN #{beginScanDate} AND #{endScanDate}
			</if>
			<if test="scanDate !=null">
				<![CDATA[ and scan_date=#{scanDate} ]]>
			</if>
			<if test="endScanDate !=null">
				<![CDATA[ and scan_date <=#{endScanDate} ]]>
			</if>
			and del_flag=0
		</where>
	</sql>
	<sql id="whereCondition">
		<where>
			1=1
			<if test="siteCode != null ">
				and site_code like '${siteCode}%'
				
			</if>
			<if test="group !=null ">
				and create_time BETWEEN DATE_SUB(NOW(),INTERVAL 12 MONTH) AND NOW()
			</if>
			and del_flag=0
		</where>
	</sql>
	<!-- 添加 -->
	<insert id="add" parameterType="com.ucap.cloud_web.entity.SecurityBlankDetail" useGeneratedKeys="true" keyProperty="id">
		insert into security_blank_detail ( 
			<if test="id != null ">id,</if>
			<if test="securityBlankInfo != null ">security_blank_info,</if>
			<if test="servicePeriodId != null ">service_period_id,</if>
			<if test="siteCode != null ">site_code,</if>
			<if test="channelName != null ">channel_name,</if>
			<if test="url != null ">url,</if>
			<if test="path != null ">path,</if>
			<if test="imgUrl != null ">img_url,</if>
			<if test="scanDate != null ">scan_date,</if>
			<if test="delFlag != null ">del_flag,</if>
			create_time
		) values (
			<if test="id != null ">#{id},</if>
			<if test="securityBlankInfo != null ">#{securityBlankInfo},</if>
			<if test="servicePeriodId != null ">#{servicePeriodId},</if>
			<if test="siteCode != null ">#{siteCode},</if>
			<if test="channelName != null ">#{channelName},</if>
			<if test="url != null ">#{url},</if>
			<if test="path != null ">#{path},</if>
			<if test="imgUrl != null ">#{imgUrl},</if>
			<if test="scanDate != null ">#{scanDate},</if>
			<if test="delFlag != null ">#{delFlag},</if>
			now()
		)
	</insert>

	<!-- 查询 -->
	<select id="get" parameterType="int" resultType="com.ucap.cloud_web.entity.SecurityBlankDetail">
		select * from security_blank_detail where id=#{id}
	</select>

	<!-- 修改 -->
	<update id="update" parameterType="com.ucap.cloud_web.entity.SecurityBlankDetail">
		update security_blank_detail 
			<trim prefix="SET" suffixOverrides=",">
				<if test="id != null ">id = #{id},</if>
				<if test="securityBlankInfo != null ">security_blank_info = #{securityBlankInfo},</if>
				<if test="servicePeriodId != null ">service_period_id = #{servicePeriodId},</if>
				<if test="siteCode != null ">site_code = #{siteCode},</if>
				<if test="channelName != null ">channel_name = #{channelName},</if>
				<if test="url != null ">url = #{url},</if>
				<if test="path != null ">path = #{path},</if>
				<if test="imgUrl != null ">img_url = #{imgUrl},</if>
				<if test="scanDate != null ">scan_date = #{scanDate},</if>
				<if test="createTime != null ">create_time = #{createTime},</if>
				<if test="delFlag != null ">del_flag = #{delFlag}</if>
			</trim>
			where id=#{id} 
	</update>

	<!-- 删除 -->
	<delete id="delete" parameterType="int">
		delete from security_blank_detail where id = #{id}
	</delete>

	<!-- 分页查询 -->
	<select id="query" parameterType="HashMap" resultMap="resultMap">
		select * from security_blank_detail
		<include refid="where"/>
		<if test="queryOrderList != null">
			order by
			<foreach collection="queryOrderList" item="queryOrder" separator=",">
				${queryOrder}
			</foreach>
		</if>
		<if test="start != null and pageSize != null">
			limit #{start}, #{pageSize}
		</if>
	</select>
	
	<select id="queryCount" parameterType="HashMap" resultType="int">
		select count(*) from security_blank_detail
		<include refid="where" />
	</select>
	
	<select id="queryByGroup" parameterType="HashMap" resultType="com.ucap.cloud_web.dto.SecurityBlankDetailRequest">
		SELECT count(id) as blankChannelSum, SUBSTRING(create_time,1,7) AS returnTime FROM security_blank_detail 
		<include refid="whereCondition" />
		GROUP BY SUBSTRING(create_time,1,7)
	</select>
	
	<select id="getBlankNum" parameterType="HashMap" resultType="com.ucap.cloud_web.dto.SecurityBlankDetailRequest">
		SELECT 
		  COUNT(sb.id) AS blankNum,
		  sb.site_code AS siteCode,
		  wb.name AS siteName,
		  wb.url AS homePageUrl,
		  wb.jump_url AS jumpPageUrl,
		  wb.isorganizational AS isorganizational,
		  wb.director AS director,
		  wb.address AS address,
		  wb.principal_name AS principalName,
		  wb.telephone AS telephone,
		  wb.mobile AS mobile,
		  wb.email AS email,
		  wb.linkman_name AS linkmanName,
		  wb.telephone_2 AS telephone2,
		  wb.mobile_2 AS mobile2,
		  wb.email_2 AS email2
		FROM
		  security_blank_detail sb,
		  service_period sp,
		  database_info wb 
		WHERE sb.service_period_id = sp.id 
		  AND sb.site_code = wb.site_code 
		  and sb.del_flag=0
		  <if test="scanDate !=null">
		  	and sb.create_time like '${scanDate}%'
		  </if>
		  <if test="ids != null">
		 	and sb.site_code in
	        <foreach collection="ids" item="term" open="(" separator="," close=")">
	     		#{term.siteCode}
			</foreach>
		  </if>
		GROUP BY sb.site_code 
		ORDER BY blankNum DESC 
	
	</select>

	<select id="queryBlankNum" parameterType="HashMap" resultType="com.ucap.cloud_web.dto.SecurityBlankDetailRequest">
	SELECT 
		  count(*) AS blankNum,
		  sbi.site_code AS siteCode,
		  sbi.service_period_id AS servicePeriodId
		FROM
		  security_blank_detail sbi,
		  service_period sp 
		WHERE sbi.service_period_id = sp.id 
			<if test="siteCode !=null">
				AND sbi.site_code =#{siteCode}
			</if>
			<if test="linkList !=null">
				and sbi.site_code in
		        <foreach collection="linkList" item="term" open="(" separator="," close=")">
		     		#{term.siteCode}
				</foreach>
			</if>
			<if test="nowDate !=null">
				AND #{nowDate} BETWEEN sp.start_date AND sp.end_date
			</if>
			<if test="scanDate !=null">
				AND sbi.scan_date=#{scanDate}
			</if>
			GROUP BY sbi.site_code,sbi.service_period_id
			<if test="blankNum !=null">
				HAVING blankNum > #{blankNum}
			</if>
	
	</select>
	
	
	
	<select id="getBlankNumber" parameterType="HashMap" resultType="com.ucap.cloud_web.dtoResponse.SecurityGuaranteeResponse">
		SELECT
			COUNT(id) columnNum,site_code siteCode	
		FROM
			security_blank_detail
   		<include refid="where" />
   		GROUP BY siteCode
	</select>
	
	<select id="queryBlankInfoByTree" parameterType="HashMap" resultType="com.ucap.cloud_web.dto.SecurityBlankDetailRequest">
			SELECT 
			  sr.service_period_id AS servicePeriodId,
			  sr.site_code AS siteCode,
			  di.name AS siteName,
			  COUNT(sr.id) AS blankNum 
			FROM
			  security_blank_detail sr 
			  LEFT JOIN database_tree_info dti 
			    ON sr.site_code = dti.site_code 
			  LEFT JOIN database_info di 
			    ON dti.site_code = di.site_code 
			WHERE 1 = 1
		    <if test="servicePeroidId !=null">
		    	AND sr.service_period_id=#{servicePeroidId}
		    </if>
		    <if test="orgSiteCode !=null">
		    	AND dti.org_site_code=#{orgSiteCode}
		    </if>
		    <if test="isLink !=null">
		    	AND dti.is_link=#{isLink}
		    </if>
		   <if test="siteType !=null">
		    	AND dti.layer_type=#{siteType}
		    </if>
		   <if test="isExp !=null">
		    	AND  di.isexp=#{isExp}
		   </if>
		   <if test="delFlag !=null">
		   		AND sr.del_flag=#{delFlag}
		   </if>
		   <if test="scanDate !=null">
	    		<![CDATA[AND sr.scan_date <=#{scanDate}]]>
	       </if>
		   GROUP BY sr.site_code
		   ORDER BY blankNum DESC
		   <if test="begin !=null and end !=null">
			limit #{begin},#{end}
		  </if>
	</select>
	<select id="queryBlankInfoByTreeCount" parameterType="HashMap" resultType="int">
		SELECT COUNT(*) FROM (
			SELECT 
				  sr.service_period_id AS servicePeriodId,
				  sr.site_code AS siteCode,
				  di.name AS siteName,
				  COUNT(sr.id) AS blankNum 
				FROM
				  security_blank_detail sr 
				  LEFT JOIN database_tree_info dti 
				    ON sr.site_code = dti.site_code 
				  LEFT JOIN database_info di 
				    ON dti.site_code = di.site_code 
				WHERE 1 = 1
			    <if test="servicePeroidId !=null">
			    	AND sr.service_period_id=#{servicePeroidId}
			    </if>
			    <if test="orgSiteCode !=null">
			    	AND dti.org_site_code=#{orgSiteCode}
			    </if>
			    <if test="isLink !=null">
			    	AND dti.is_link=#{isLink}
			    </if>
			   <if test="siteType !=null">
			    	AND dti.layer_type=#{siteType}
			    </if>
			   <if test="isExp !=null">
			    	AND  di.isexp=#{isExp}
			   </if>
			   <if test="scanDate !=null">
	    			<![CDATA[AND sr.scan_date <=#{scanDate}]]>
	       	   </if>
			   <if test="delFlag !=null">
			   		AND sr.del_flag=#{delFlag}
			   </if>
			   GROUP BY sr.site_code
		) AS a
			
	</select>
</mapper>
