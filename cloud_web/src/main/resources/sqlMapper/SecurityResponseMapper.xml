<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ucap.cloud_web.dao.SecurityResponseDao">
<cache eviction="LRU" flushInterval="60000" size="1024" readOnly="true"/>
	<resultMap type="com.ucap.cloud_web.entity.SecurityResponse" id="resultMap"/>

	<sql id="where">
		<where>
			1=1
			<if test="siteCode != null ">
				and site_code like '${siteCode}%'
			</if>
			
			<if test="servicePeriodId != null and servicePeriodId !=0">
				and service_period_id = #{servicePeriodId}
			</if>
			<if test="channelName != null ">
				and channel_name like '%${channelName}%'
			</if>
			<if test="channelUrl !=null">
				and channel_url=#{channelUrl}
			</if>
			<if test="startTime !=null and endTime !=null" >
				and scan_date BETWEEN #{startTime} AND #{endTime}
			</if>
			<if test="beginScanDate !=null and endScanDate !=null">
                and create_time BETWEEN #{beginScanDate} AND #{endScanDate}
			</if>
			<if test="dicChannelIdArray !=null">
				and dic_channel_id in
            	<foreach collection="dicChannelIdArray" item="item" open="(" separator="," close=")">
       					#{item}
				</foreach>
			</if>
			<if test="createTime !=null">
				and create_time like '${createTime}%'
			</if>
			<if test="endScanDate !=null">
				<![CDATA[ and scan_date<=#{endScanDate} ]]>
			</if>
			and del_flag=0
		</where>
	</sql>

	<sql id="whereCondition">
		<where>
			1=1
			<if test="siteCode != null ">
				and site_code like '${siteCode}%'
			</if>
			<if test="group !=null ">
				and create_time BETWEEN DATE_SUB(NOW(),INTERVAL 12 MONTH) AND NOW()
			</if>
			<if test="endTime != null and startTime !=null">
				and create_time between #{startTime} and #{endTime}
			</if>
			and del_flag=0
		</where>
	</sql>
	<!-- 添加 -->
	<insert id="add" parameterType="com.ucap.cloud_web.entity.SecurityResponse" useGeneratedKeys="true" keyProperty="id">
		insert into security_response ( 
			<if test="id != null ">id,</if>
			<if test="dicChannelId != null ">dic_channel_id,</if>
			<if test="siteCode != null ">site_code,</if>
			<if test="servicePeriodId != null ">service_period_id,</if>
			<if test="channelName != null ">channel_name,</if>
			<if test="channelUrl != null ">channel_url,</if>
			<if test="problemTypeId != null ">problem_type_id,</if>
			<if test="problemDesc != null ">problem_desc,</if>
			<if test="imgUrl != null ">img_url,</if>
			<if test="scanDate != null ">scan_date,</if>
			<if test="delFlag != null ">del_flag,</if>
			create_time
		) values (
			<if test="id != null ">#{id},</if>
			<if test="dicChannelId != null ">#{dicChannelId},</if>
			<if test="siteCode != null ">#{siteCode},</if>
			<if test="servicePeriodId != null ">#{servicePeriodId},</if>
			<if test="channelName != null ">#{channelName},</if>
			<if test="channelUrl != null ">#{channelUrl},</if>
			<if test="problemTypeId != null ">#{problemTypeId},</if>
			<if test="problemDesc != null ">#{problemDesc},</if>
			<if test="imgUrl != null ">#{imgUrl},</if>
			<if test="scanDate != null ">#{scanDate},</if>
			<if test="delFlag != null ">#{delFlag},</if>
			now()
		)
	</insert>

	<!-- 查询 -->
	<select id="get" parameterType="int" resultType="com.ucap.cloud_web.entity.SecurityResponse">
		select * from security_response where id=#{id}
	</select>

	<!-- 修改 -->
	<update id="update" parameterType="com.ucap.cloud_web.entity.SecurityResponse">
		update security_response 
			<trim prefix="SET" suffixOverrides=",">
				<if test="id != null ">id = #{id},</if>
				<if test="dicChannelId != null ">dic_channel_id = #{dicChannelId},</if>
				<if test="siteCode != null ">site_code = #{siteCode},</if>
				<if test="servicePeriodId != null ">service_period_id = #{servicePeriodId},</if>
				<if test="channelName != null ">channel_name = #{channelName},</if>
				<if test="channelUrl != null ">channel_url = #{channelUrl},</if>
				<if test="problemTypeId != null ">problem_type_id = #{problemTypeId},</if>
				<if test="problemDesc != null ">problem_desc = #{problemDesc},</if>
				<if test="imgUrl != null ">img_url = #{imgUrl},</if>
				<if test="scanDate != null ">scan_date = #{scanDate},</if>
				<if test="createTime != null ">create_time = #{createTime},</if>
				<if test="delFlag != null ">del_flag = #{delFlag}</if>
			</trim>
			where id=#{id} 
	</update>

	<!-- 删除 -->
	<delete id="delete" parameterType="int">
		delete from security_response where id = #{id}
	</delete>

	<!-- 分页查询 -->
	<select id="query" parameterType="HashMap" resultMap="resultMap">
		select * from security_response
		<include refid="where"/>
		<if test="queryOrderList != null">
			order by
			<foreach collection="queryOrderList" item="queryOrder" separator=",">
				${queryOrder}
			</foreach>
		</if>
		<if test="start != null and pageSize != null">
			limit #{start}, #{pageSize}
		</if>
	</select>
	<select id="queryCount" parameterType="HashMap" resultType="int">
		select count(*) from security_response
		<include refid="where" />
	</select>
	<select id="queryBarNum" parameterType="HashMap" resultType="com.ucap.cloud_web.dto.SecurityBlankInfoRequest">
		select count(*) as blankNum, DATE_FORMAT(create_time, '%Y-%m') 
		from security_response 
		<include refid="where" />
		group by DATE_FORMAT(create_time, '%Y-%m')
		order by create_time desc
	</select>
	
	<!-- 互动回应栏目统计数据获取 -->
	<select id="queryByMap" parameterType="HashMap" resultType="com.ucap.cloud_web.dto.SecurityResponseRequest">
		select count(*) as channelSum,dic_channel_id as dicChannelId from security_response
		<include refid="whereCondition" />
		group by dic_channel_id
	</select>

	
	<select id="queryByGroup" parameterType="HashMap" resultType="com.ucap.cloud_web.dto.SecurityResponseRequest">
		SELECT count(id) as channelSum, SUBSTRING(create_time,1,7) AS returnTime FROM security_response 
		<include refid="whereCondition" />
		GROUP BY SUBSTRING(create_time,1,7)
	</select>
	<select id="getProblemNum" parameterType="HashMap" resultType="com.ucap.cloud_web.dto.SecurityResponseRequest">
		SELECT 
		  COUNT(sr.id) AS problemNum,
		  sr.site_code AS siteCode,
		  wb.name AS siteName,
		  wb.url AS homePageUrl,
		  wb.jump_url AS jumpPageUrl,
		  wb.isorganizational AS isorganizational,
		  wb.director AS director,
		  wb.address AS address,
		  wb.principal_name AS principalName,
		  wb.telephone AS telephone,
		  wb.mobile AS mobile,
		  wb.email AS email,
		  wb.linkman_name AS linkmanName,
		  wb.telephone_2 AS telephone2,
		  wb.mobile_2 AS mobile2,
		  wb.email_2 AS email2 
		FROM
		  security_response sr,
		  service_period sp,
		  database_info wb 
		WHERE sr.service_period_id = sp.id 
		  AND sr.site_code = wb.site_code 
		  and sr.del_flag=0
		<if test="servicePeriodId !=null">
			and sr.service_period_id=#{servicePeriodId}
		</if>
		<if test="scanDate !=null">
		  	and sr.create_time like '${scanDate}%'
		</if>
		<if test="ids != null">
		 	and sr.site_code in
	        <foreach collection="ids" item="term" open="(" separator="," close=")">
	     		#{term.siteCode}
			</foreach>
		</if>
		<if test="nowTime !=null">
		  	AND #{nowTime} BETWEEN  wb.service_begin_time AND wb.service_end_time
		</if>
		 <if test="siteCodeLike != null ">
				and sr.site_code like  concat('%',#{siteCodeLike},'%')
		</if>
		GROUP BY sr.site_code
		order by problemNum desc
	</select>
	<select id="queryListByChannelName" parameterType="HashMap" resultType="com.ucap.cloud_web.dto.SecurityHomeChannelRequest">
		SELECT count(*) as channelSum ,  channel_name
		FROM security_response
		WHERE  site_code = #{siteCode}  
		AND (scan_date BETWEEN #{startTime} and #{endTime}) 
		AND dic_channel_id = ${dicChannelId}
		and del_flag=0
		group by channel_name
	</select>
	
	
	<select id="queryResponseNum" parameterType="HashMap" resultType="com.ucap.cloud_web.dto.SecurityResponseRequest">
		SELECT 
		  sbi.site_code AS siteCode,
		  sbi.channel_url AS channelUrl,
		  sbi.problem_type_id AS problemTypeId,
		  sbi.problem_desc as problemDesc,
		  sbi.service_period_id AS servicePeriodId
		FROM
		  security_response sbi,
		  service_period sp 
		WHERE sbi.service_period_id = sp.id 
			<if test="siteCode !=null">
				  and sbi.site_code = #{siteCode}
			</if>
			<if test="nowDate !=null">
				AND #{nowDate} BETWEEN sp.start_date AND sp.end_date
			</if>
			<if test="scanDate !=null">
				AND sbi.scan_date=#{scanDate}
			</if>
		   	<if test="linkList !=null">
		   		and sbi.site_code in
		   		<foreach collection="linkList" item="item" open="(" separator="," close=")">
		   			#{item.siteCode}
		   		</foreach>
		   	</if>
		  group BY sbi.channel_url,sbi.service_period_id
	</select>
	
	
	<select id="getResponseNumber" parameterType="HashMap" resultType="com.ucap.cloud_web.dtoResponse.SecurityGuaranteeResponse">
		SELECT 
			COUNT(id) columnNum,site_code siteCode	
		FROM security_response 
   		<include refid="where"/>
   		GROUP BY siteCode
	</select>
	
	
	<select id="queryInfoByTree" parameterType="HashMap" resultType="com.ucap.cloud_web.dto.SecurityResponseRequest">
		SELECT 
		  sr.service_period_id AS servicePeriodId,
		  sr.site_code AS siteCode,
		  di.name AS siteName,
		  COUNT(sr.id) AS problemNum
		FROM
		  security_response sr 
		  LEFT JOIN database_tree_info dti 
		    ON sr.site_code = dti.site_code 
		  LEFT JOIN database_info di 
		    ON dti.site_code = di.site_code
		    WHERE 1=1
		    <if test="servicePeroidId !=null">
		    	AND sr.service_period_id=#{servicePeroidId}
		    </if>
		    <if test="orgSiteCode !=null">
		    	AND dti.org_site_code=#{orgSiteCode}
		    </if>
		    <if test="isLink !=null">
		    	AND dti.is_link=#{isLink}
		    </if>
		   <if test="siteType !=null">
		    	AND dti.layer_type=#{siteType}
		    </if>
		   <if test="isExp !=null">
		    	AND  di.isexp=#{isExp}
		    </if>
		    <if test="endScanDate !=null">
		    	<![CDATA[AND sr.scan_date <=#{endScanDate}]]>
		    </if>
		    GROUP BY sr.site_code
		    ORDER BY problemNum DESC
		   <if test="begin !=null and end !=null">
			limit #{begin},#{end}
		  </if>
	</select>
	<select id="queryInfoByTreeCount" parameterType="HashMap" resultType="int">
		SELECT COUNT(*) FROM (
			SELECT 
			  sr.service_period_id AS servicePeriodId,
			  sr.site_code AS siteCode,
			  di.name AS siteName,
			  COUNT(sr.id) AS problemNum
			FROM
			  security_response sr 
			  LEFT JOIN database_tree_info dti 
			    ON sr.site_code = dti.site_code 
			  LEFT JOIN database_info di 
			    ON dti.site_code = di.site_code
			    WHERE 1=1
			    <if test="servicePeroidId !=null">
			    	AND sr.service_period_id=#{servicePeroidId}
			    </if>
			    <if test="orgSiteCode !=null">
			    	AND dti.org_site_code=#{orgSiteCode}
			    </if>
			    <if test="isLink !=null">
			    	AND dti.is_link=#{isLink}
			    </if>
			    <if test="endScanDate !=null">
			    	<![CDATA[AND sr.scan_date <=#{endScanDate}]]>
			    </if>			    
			   <if test="siteType !=null">
			    	AND dti.layer_type=#{siteType}
			    </if>
			   <if test="isExp !=null">
			    	AND  di.isexp=#{isExp}
			    </if>
			    GROUP BY sr.site_code
		)AS a
		
	</select>
</mapper>
