<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ucap.cloud_web.dao.TempReportDao">

	<cache eviction="LRU" flushInterval="60000" size="1024" readOnly="true"/>

	<resultMap type="com.ucap.cloud_web.entity.TempReport" id="resultMap"/>

	<sql id="where">
		<where>
			1=1
			<if test="siteCode != null ">
				and site_code=#{siteCode}
			</if>
		</where>
	</sql>

	<!-- 添加 -->
	<insert id="add" parameterType="com.ucap.cloud_web.entity.TempReport" useGeneratedKeys="true" keyProperty="id">
		insert into temp_report ( 
			<if test="id != null ">id,</if> 
			<if test="siteCode != null ">site_code,</if>
			<if test="orgSiteCode != null ">org_site_code,</if>
			<if test="reportName != null ">report_name,</if>
			<if test="reportReason != null ">report_reason,</if>
			<if test="reportDetail != null ">report_detail,</if>
			<if test="reportStartDate != null ">report_start_date,</if>
			<if test="reportEndDate != null ">report_end_date,</if>
			<if test="startTime != null ">start_time,</if>
			<if test="endTime != null ">end_time,</if>
			<if test="isCycle != null ">is_cycle,</if>
			<if test="reportDate != null ">report_date,</if>
			<if test="status != null ">status,</if>
			create_time,
			modify_time
		) values (
			<if test="id != null ">#{id},</if> 
			<if test="siteCode != null ">#{siteCode},</if>
			<if test="orgSiteCode != null ">#{orgSiteCode},</if>
			<if test="reportName != null ">#{reportName},</if>
			<if test="reportReason != null ">#{reportReason},</if>
			<if test="reportDetail != null ">#{reportDetail},</if>
			<if test="reportStartDate != null ">#{reportStartDate},</if>
			<if test="reportEndDate != null ">#{reportEndDate},</if>
			<if test="startTime != null ">#{startTime},</if>
			<if test="endTime != null ">#{endTime},</if>
			<if test="isCycle != null ">#{isCycle},</if>
			<if test="reportDate != null ">#{reportDate},</if>
			<if test="status != null ">#{status},</if>
			now(),
			now()
		)
		<selectKey resultType="int" keyProperty="id">
			SELECT LAST_INSERT_ID() AS id
		</selectKey>
	</insert>

	<!-- 查询 -->
	<select id="get" parameterType="int" resultType="com.ucap.cloud_web.entity.TempReport">
		select * from temp_report where id=#{id}
	</select>

	<!-- 修改 -->
	<update id="update" parameterType="com.ucap.cloud_web.entity.TempReport">
		update temp_report 
			<trim prefix="SET" suffixOverrides=",">
				<if test="id != null ">id = #{id},</if>
				<if test="siteCode != null ">site_code = #{siteCode},</if>
				<if test="orgSiteCode != null ">org_site_code = #{orgSiteCode},</if>
				<if test="reportName != null ">report_name = #{reportName},</if>
				<if test="reportReason != null ">report_reason = #{reportReason},</if>
				<if test="reportDetail != null ">report_detail = #{reportDetail},</if>
				<if test="reportStartDate != null ">report_start_date = #{reportStartDate},</if>
				<if test="reportEndDate != null ">report_end_date = #{reportEndDate},</if>
				<if test="startTime != null ">start_time = #{startTime},</if>
				<if test="endTime != null ">end_time = #{endTime},</if>
				<if test="isCycle != null ">is_cycle = #{isCycle},</if>
				<if test="status != null ">status = #{status},</if>
				<if test="createTime != null ">create_time = #{createTime},</if>
				<if test="modifyTime != null ">modify_time = #{modifyTime},</if>
			</trim>
			where id=#{id} 
	</update>

	<!-- 删除 -->
	<delete id="delete" parameterType="int">
		delete from temp_report where id = #{id}
	</delete>

	<!-- 分页查询 -->
	<select id="query" parameterType="HashMap" resultMap="resultMap">
		select * from temp_report
		<include refid="where"/>
		<if test="queryOrderList != null">
			order by
			<foreach collection="queryOrderList" item="queryOrder" separator=",">
				${queryOrder}
			</foreach>
		</if>
		<if test="start != null and pageSize != null">
			limit #{start}, #{pageSize}
		</if>
	</select>
	<select id="queryCount" parameterType="HashMap" resultType="int">
		select count(*) from temp_report
		<include refid="where" />
	</select>
	
	<select id="joinLinkData" parameterType="HashMap" resultType="com.ucap.cloud_web.entity.TempReport">
		select t.*,d.name webName from  temp_report t JOIN
		 database_info d on t.site_code = d.site_code
		<where>
		<if test="orgSiteCode != null">
			and t.org_site_code=#{orgSiteCode}
		</if>
		<if test="siteCode != null">
			and t.site_code=#{siteCode}
		</if>
		<if test="startDate != null">
			<![CDATA[ and   #{startDate}<=t.report_date]]>
		</if>
		<if test="endDate != null">
			<![CDATA[ and   t.report_date<=#{endDate}]]>
		</if>
		<if test="nameOrSiteCode != null">
			and (t.report_name like '%${nameOrSiteCode}%' or d.name like '%${nameOrSiteCode}%' 
			<if test="reportReason != null">
				or t.report_reason in (${reportReason})
			</if>
			) 
		</if>
		</where>
		order by t.status asc, t.report_date desc
	</select>
	
	
 	<select id="queryqueryListSubordinateUnits" parameterType="HashMap" resultType="com.ucap.cloud_web.entity.TempReport"> 
		SELECT DISTINCT p.*,t.name webName  from temp_report p   JOIN ( 
 			SELECT info.site_code, 
			tab.name  
 			FROM database_tree_info info 
 			LEFT JOIN database_info tab ON info.site_code = tab.site_code
 			where  1=1  
 			  <if test="levelLower != null and  levellowerlow != null "> 
				  	and ( info.level = #{levelLower} OR info.level = #{levellowerlow}) 
 			  </if> 
 			  <if test="codeLike != null"> 
 			  AND info.code LIKE  concat(#{codeLike},'%') 
 			  </if> 
 			  AND info.is_bigdata = '1'
 			  AND LENGTH(info.site_code) = 10  
 			) t ON p.site_code = t.site_code  	
 			<if test="nameOrSiteCode != null"> 
 			  AND (t.name LIKE  concat('%',#{nameOrSiteCode},'%')  or p.report_name LIKE  concat('%',#{nameOrSiteCode},'%') )
 			 </if> 
 			 <if test="reportReason != null"> 
 			  AND p.report_reason = #{reportReason}
 			 </if>
 			 <if test="startDate != null">
					<![CDATA[ and   #{startDate}<=p.report_date]]>
			</if>
			<if test="endDate != null">
				<![CDATA[ and   p.report_date<=#{endDate}]]>
			</if>
 			ORDER BY p.create_time DESC 
 		<if test="start != null and pageSize != null"> 
 			limit #{start}, #{pageSize} 
 		</if> 
	
	</select>
	
	
	<select id="queryCountLowerSubordinateUnits" parameterType="HashMap" resultType="int">
	SELECT COUNT(*)  FROM (
 		SELECT  distinct p.*,t.name from temp_report p  JOIN ( 
 			SELECT info.site_code, 
 			tab.name  
 			FROM database_tree_info info 
 			LEFT JOIN database_info tab ON info.site_code = tab.site_code
 			where  1=1  
 			  <if test="levelLower != null "> 
 			  <if test="levellowerlow != null"> 
 			  and ( info.level = #{levelLower} OR info.level = #{levellowerlow}) 
 			  </if>
 			  </if> 
			  <if test="codeLike != null"> 
 			  AND info.code LIKE concat(#{codeLike},'%') 
 			  </if> 
 			  AND info.is_bigdata = '1'
 			  AND LENGTH(info.site_code) = 10  
 			) t ON p.site_code = t.site_code  
 			 <if test="nameOrSiteCode != null"> 
 			  AND (t.name LIKE  concat('%',#{nameOrSiteCode},'%')  or p.report_name LIKE  concat('%',#{nameOrSiteCode},'%') )
 			 </if> 
 			  <if test="reportReason != null"> 
 			  AND p.report_reason = #{reportReason}
 			 </if>
 			 <if test="startDate != null">
					<![CDATA[ and   #{startDate}<=p.report_date]]>
			</if>
			<if test="endDate != null">
				<![CDATA[ and   p.report_date<=#{endDate}]]>
			</if>
			) ss
	</select>
	
</mapper>
